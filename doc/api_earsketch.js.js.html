<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: api/earsketch.js.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: api/earsketch.js.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * EarSketch API: Javascript
 *
 * This defines an init function for JS-Interpreter. These functions will be
 * injected into the interpreter by the compiler.
 *
 * @module JavascriptAPI
 * @author Creston Bunch
 */

ES_JAVASCRIPT_API = function(interpreter, scope) {
    var wrapper;

    // MASTER_TRACK constant
    interpreter.setProperty(
        scope, 'MASTER_TRACK', interpreter.createPrimitive(0)
    );

    /**
     * Function to initialize a new script in EarSketch.
     *
     * Resets the global result variable to the default value.
     */
    wrapper = function() {
        interpreter.setProperty(
            scope, '__ES_RESULT', callPassthrough(
                'init', interpreter.getProperty(scope, '__AUDIO_QUALITY')
            )
        );
        interpreter.scope = scope;
    }
    interpreter.setProperty(
        scope, 'init', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Set the tempo of the script.
     */
    wrapper = function(tempo) {
        interpreter.setProperty(
            scope, '__ES_RESULT', callPassthrough('setTempo', tempo)
        );
    }
    interpreter.setProperty(
        scope, 'setTempo', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Finish the script.
     *
     * Sets an __ES_FINISHED property on the interpreter object used to run
     * the script. This property contains the native JS compiled result.
     */
    wrapper = function() {
        interpreter.setProperty(
            scope, '__ES_RESULT', callPassthrough('finish')
        );
        interpreter.__ES_FINISHED = remapToNativeJs(
            interpreter.getProperty(scope, '__ES_RESULT')
        );
    }
    interpreter.setProperty(
        scope, 'finish', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Insert a media clip.
     */
    wrapper = function(filekey, track, start, end) {
        interpreter.setProperty(
            scope, '__ES_RESULT',
            callPassthrough('fitMedia', filekey, track, start, end)
        );
    }
    interpreter.setProperty(
        scope, 'fitMedia', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Insert a whole media block.
     */
    wrapper = function(filekey, track, start, scale) {
        interpreter.setProperty(
            scope, '__ES_RESULT',
            callPassthrough('insertMedia', filekey, track, start, scale)
        );
    }
    interpreter.setProperty(
        scope, 'insertMedia', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Insert a media slice.
     */
    wrapper = function(filekey, track, start, end, scale) {
        interpreter.setProperty(
            scope, '__ES_RESULT',
            callPassthrough(
                'insertMediaSection', filekey, track, start, end, scale
            )
        );
    }
    interpreter.setProperty(
        scope, 'insertMediaSection', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Make a beat from audio clips.
     */
    wrapper = function(filekey, track, measure, beatString) {
        interpreter.setProperty(
            scope, '__ES_RESULT',
            callPassthrough(
                'makeBeat', filekey, track, measure, beatString
            )
        );
    }
    interpreter.setProperty(
        scope, 'makeBeat', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Make a beat from audio clip slices.
     */
    wrapper = function(filekey, track, measure, beatString, beatNumber) {
        interpreter.setProperty(
            scope, '__ES_RESULT',
            callPassthrough(
                'makeBeatSlice', filekey, track, measure, beatString, beatNumber
            )
        );
    }
    interpreter.setProperty(
        scope, 'makeBeatSlice', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Analyze a clip.
     */
    wrapper = function(filekey, feature) {
        var callback = arguments[arguments.length-1];
        suspendPassthrough('analyze', callback, filekey, feature);
    }
    interpreter.setProperty(
        scope, 'analyze', interpreter.createAsyncFunction(wrapper)
    );

    /**
     * Analyze a clip for time.
     */
    wrapper = function(filekey, feature, start, end) {
        var callback = arguments[arguments.length-1];
        suspendPassthrough(
            'analyzeForTime', callback, filekey, feature, start, end
        );
    }
    interpreter.setProperty(
        scope, 'analyzeForTime', interpreter.createAsyncFunction(wrapper)
    );

    /**
     * Analyze a track
     */
    wrapper = function(track, feature) {
        var callback = arguments[arguments.length-1];
        suspendPassthrough(
            'analyzeTrack', callback, track, feature
        );
    }
    interpreter.setProperty(
        scope, 'analyzeTrack', interpreter.createAsyncFunction(wrapper)
    );

    /**
     * Analyze a track for time
     */
    wrapper = function(track, feature, start, end) {
        var callback = arguments[arguments.length-1];
        suspendPassthrough(
            'analyzeTrackForTime', callback, track, feature, start, end
        );
    }
    interpreter.setProperty(
        scope, 'analyzeTrackForTime', interpreter.createAsyncFunction(wrapper)
    );

    /**
     * Get the duration of a clip.
     */
    wrapper = function(filekey) {
        var callback = arguments[arguments.length-1];
        suspendPassthrough('dur', callback, filekey);
    }
    interpreter.setProperty(
        scope, 'dur', interpreter.createAsyncFunction(wrapper)
    );

    /**
     * Return a random number from a Gaussian distribution.
     */
    wrapper = function(mean, std) {
        return callPassthrough('gauss', mean, std);
    }
    interpreter.setProperty(
        scope, 'gauss', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Import an image as number data.
     */
    wrapper = function(imageURL, nrows, ncols, color) {
        return callPassthrough('importImage', imageURL, nrows, ncols, color);
    }
    interpreter.setProperty(
        scope, 'importImage', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Import a file as string data.
     */
    wrapper = function(fileURL) {
        return callPassthrough('importFile', fileURL);
    }
    interpreter.setProperty(
        scope, 'importFile', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Provides a way to print to the EarSketch console from JavaScript.
     */
    wrapper = function(msg) {
        return callPassthrough('println', msg);
    }
    interpreter.setProperty(
        scope, 'println', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Provides a way to get user input from JavaScript.
     */
    wrapper = function(msg) {
        return callPassthrough('prompt', msg);
    }
    interpreter.setProperty(
        scope, 'prompt', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Alias of prompt
     */
    wrapper = function(msg) {
        return callPassthrough('prompt', msg);
    }
    interpreter.setProperty(
        scope, 'readInput', interpreter.createNativeFunction(wrapper)
    );


    /**
     * Replace elements in a list.
     */
    wrapper = function(list, find, replace) {
        return callPassthrough('replaceListElement', list, find, replace);
    }
    interpreter.setProperty(
        scope, 'replaceListElement', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Replace characters in a string.
     */
    wrapper = function(string, find, replace) {
        return callPassthrough('replaceString', string, find, replace);
    }
    interpreter.setProperty(
        scope, 'replaceString', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Reverse a list.
     */
    wrapper = function(list) {
        return callPassthrough('reverseList', list);
    }
    interpreter.setProperty(
        scope, 'reverseList', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Reverse a string.
     */
    wrapper = function(string) {
        return callPassthrough('reverseString', string);
    }
    interpreter.setProperty(
        scope, 'reverseString', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Add effects using a beatstring.
     */
    wrapper = function(track, effect, parameter, list, measure, string) {
        interpreter.setProperty(
            scope, '__ES_RESULT',
            callPassthrough(
                'rhythmEffects', track, effect, parameter, list, measure, string
            )
        );
    }
    interpreter.setProperty(
        scope, 'rhythmEffects', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Add an effect
     */
    wrapper = function(track, effect, parameter,
    startVal, startLoc, endVal, endLoc) {
        interpreter.setProperty(
            scope, '__ES_RESULT',
            callPassthrough(
                'setEffect', track, effect, parameter,
                startVal, startLoc, endVal, endLoc
            )
        );
    }
    interpreter.setProperty(
        scope, 'setEffect', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Select a random file.
     */
    wrapper = function(folder, extension) {
        return callPassthrough('selectRandomFile', folder, extension);
    }
    interpreter.setProperty(
        scope, 'selectRandomFile', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Shuffle a list
     */
    wrapper = function(list) {
        return callPassthrough('shuffleList', list);
    }
    interpreter.setProperty(
        scope, 'shuffleList', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Shuffle a string
     */
    wrapper = function(string) {
        return callPassthrough('shuffleString', string);
    }
    interpreter.setProperty(
        scope, 'shuffleString', interpreter.createNativeFunction(wrapper)
    );

    /**
     * Helper function for easily wrapping a function around the passthrough.
     *
     * @private
     */
    function callPassthrough() {
        // the first argument should be the passthrough function name
        var func = arguments[0];

        var args = [];
        // put in the result as the new first argument
        args.unshift(remapToNativeJs(
            interpreter.getProperty(scope, '__ES_RESULT')
        ));

        // convert arguments to JavaScript types
        for (var i = 1; i &lt; arguments.length; i++) {
            if (arguments[i] === undefined) {
                continue;
            }
            args.push(remapToNativeJs(arguments[i]));
        }

        return wrapJsErrors(function() {
            return remapToPseudoJs(
                ES_PASSTHROUGH[func].apply(this, args)
            );
        });
    }

    /**
     * Helper function for easily wrapping a function around the passthrough
     * that returns a promise.
     *
     * See dur() or analyze() for examples on how to use this function.
     *
     * @param {string} func The function name to call in the passthrough.
     * @param {function} callback The callback function for asynchronous
     * execution using JS-Interpreter.
     * @private
     */
    function suspendPassthrough() {
        // the first argument should be the passthrough function name
        var func = arguments[0];
        var callback = arguments[1];

        var args = [];
        // put in the result as the new first argument
        args.unshift(remapToNativeJs(
            interpreter.getProperty(scope, '__ES_RESULT')
        ));

        // convert arguments to JavaScript types
        for (var i = 2; i &lt; arguments.length; i++) {
            if (arguments[i] === undefined ||
                typeof(arguments[i]) == 'function') {
                continue;
            }
            args.push(remapToNativeJs(arguments[i]));
        }

        wrapJsErrors(function() {
            var promise = ES_PASSTHROUGH[func].apply(this, args);
            promise.then(function(result) {
                callback(remapToPseudoJs(result));
            }).catch(function(err) {
                throw err;
            });
        });
    }

    /**
     * Helper function that converts an arguments object into an array.
     *
     * @private
     */
    function copyArgs(args) {
        var result = [];
        for (var i = 0; i &lt; args.length; i++) {
            result.push(args[i]);
        }
        return result;
    }

    /**
     * Helper function for wrapping error handling. Adds the line number of
     * the error, etc.
     *
     * @private
     */
    function wrapJsErrors(func) {
        try {
            return func();
        } catch(e) {
            throw e;
        }
    }

    /**
     * Helper function for JS-Interpreter to map an arbitrary real Javascript
     * variable into a pseudo Javascript variable.
     *
     * @param {object|string|number} v The variable to map.
     */
    function remapToPseudoJs(v) {
        if (!(v instanceof Object)) {
            // case v is not an object, return a mapped primitive type
            return interpreter.createPrimitive(v);
        }
        if (v instanceof Array) {
            // case v is an array
            var pseudoList = interpreter.createObject(interpreter.ARRAY);

            for (var i=0; i &lt; v.length; i++) {
                // recursively remap nested values
                var remappedVal = remapToPseudoJs(v[i]);
                interpreter.setProperty(pseudoList, i, remappedVal);
            }
            return pseudoList;
        } else {
            // case v is an object, map the object
            var pseudoObject = interpreter.createObject();

            for (var key in v) {
                // recursively remap nested values
                var remappedVal = remapToPseudoJs(v[key]);
                interpreter.setProperty(pseudoObject, key, remappedVal);
            }

            return pseudoObject;
        }
    }

    /**
     * Helper function for JS-Interpreter to map an arbitrary pseudo Javascript
     * variable into a native javascript variable.
     *
     * @param {object} v The pseudo variable to map.
     */
    function remapToNativeJs(v) {
        if (v.isPrimitive) {
            return v.data;
        }

        var nativeObject;
        if (v.length !== undefined) { // is an array
            nativeObject = [];
            for (var i = 0; i &lt; v.length; i++) {
                nativeObject[i] = remapToNativeJs(v.properties[i]);
            }
        } else { // is an object
            nativeObject = {};
            for (var key in v.properties) {
                nativeObject[key] = remapToNativeJs(v.properties[key]);
            }
        }

        return nativeObject;
    }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-accountController.html">accountController</a></li><li><a href="module-Analyze.html">Analyze</a></li><li><a href="module-apibrowserController.html">apibrowserController</a></li><li><a href="module-audioContext.html">audioContext</a></li><li><a href="module-audioeffects.html">audioeffects</a></li><li><a href="module-audioLibrary.html">audioLibrary</a></li><li><a href="module-autograderController.html">autograderController</a></li><li><a href="module-buildAudioNodeGraph.html">buildAudioNodeGraph</a></li><li><a href="module-changepasswordController.html">changepasswordController</a></li><li><a href="module-ColorPickerCtrl.html">ColorPickerCtrl</a></li><li><a href="module-compiler.html">compiler</a></li><li><a href="module-dawClip.html">dawClip</a></li><li><a href="module-dawClipName.html">dawClipName</a></li><li><a href="module-dawContainerController.html">dawContainerController</a></li><li><a href="module-dawController.html">dawController</a></li><li><a href="module-dawEffect.html">dawEffect</a></li><li><a href="module-dawTimeline.html">dawTimeline</a></li><li><a href="module-dawTrackController.html">dawTrackController</a></li><li><a href="module-DownloadFileCtrl.html">DownloadFileCtrl</a></li><li><a href="module-EarSketchApp.html">EarSketchApp</a></li><li><a href="module-forgotpasswordController.html">forgotpasswordController</a></li><li><a href="module-ideController.html">ideController</a></li><li><a href="module-JavascriptAPI.html">JavascriptAPI</a></li><li><a href="module-mainController.html">mainController</a></li><li><a href="module-NativeJavascriptAPI.html">NativeJavascriptAPI</a></li><li><a href="module-Passthrough.html">Passthrough</a></li><li><a href="module-pitchshifter.html">pitchshifter</a></li><li><a href="module-player.html">player</a></li><li><a href="module-PythonAPI.html">PythonAPI</a></li><li><a href="module-renameController.html">renameController</a></li><li><a href="module-renderer.html">renderer</a></li><li><a href="module-ReportErrorCtrl.html">ReportErrorCtrl</a></li><li><a href="module-SaveScriptCtrl.html">SaveScriptCtrl</a></li><li><a href="module-uploader.html">uploader</a></li><li><a href="module-userConsole.html">userConsole</a></li><li><a href="module-userNotification.html">userNotification</a></li><li><a href="module-WaveforrmCache.html">WaveforrmCache</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addESTagToLog">addESTagToLog</a></li><li><a href="global.html#addESTagToNotLog">addESTagToNotLog</a></li><li><a href="global.html#addESTagToNotPrint">addESTagToNotPrint</a></li><li><a href="global.html#addESTagToPrint">addESTagToPrint</a></li><li><a href="global.html#esconsole">esconsole</a></li><li><a href="global.html#ESLog">ESLog</a></li><li><a href="global.html#formatResultForTests">formatResultForTests</a></li><li><a href="global.html#formatScriptForTests">formatScriptForTests</a></li><li><a href="global.html#getURLParameters">getURLParameters</a></li><li><a href="global.html#ServiceWrapper">ServiceWrapper</a></li><li><a href="global.html#setESConsoleTraceLevel">setESConsoleTraceLevel</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.3</a> on Thu Feb 11 2016 16:06:08 GMT-0500 (EST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
