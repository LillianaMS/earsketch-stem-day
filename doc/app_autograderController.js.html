<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app/autograderController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app/autograderController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module autograderController
 */

app.controller("autograderController",
['$scope','compiler', 'Upload','userConsole',
function($scope, compiler, Upload, userConsole) {

    $scope.uploads = [];
    $scope.referenceFile = null;
    $scope.compilingReference = false;
    $scope.compileError = '';

    // Loading ogg by default for browsers other than Safari
    if (whichBrowser().match('Opera|Chrome|Firefox|Msie|Trident') !== null) {
        $scope.quality = true;//false wav, true ogg
    } else {
        $scope.quality = false;//false wav, true ogg
    }

    /**
     * Compile a script as python or javascript based on the extension and
     * return the compilation promise.
     */
    $scope.compile = function(script, filename) {
        // TODO: replace with helper function
        var ext = filename.match(/.[^.]*$/)[0];
        if (ext == '.py') {
            return compiler.compilePython(script, $scope.quality);
        } else {
            return compiler.compileJavascript(script, $scope.quality);
        }
    }
    /**
     * Read a File object and return a promise that will resolve to the
     * file text contents.
     */
    $scope.readFile = function(file) {
        var p = new Promise(function(resolve, reject) {
            var r = new FileReader();
            r.onload = function(evt) {
                var result = evt.target.result;
                resolve(result);
            }
            r.onerror = function(err) {
                reject(err);
            }
            r.readAsText(file);
        });

        return p;
    }

    /**
     * Listen for changes to the reference file.
     */
    $scope.$watch(function() {return $scope.referenceFile; }, function (file) {
        $scope.uploads = [];
        $scope.compileError = '';
        $scope.referenceResult = null;
        if (file !== null) {
            $scope.readFile(file)
            .then(function(script) {
                $scope.compilingReference = true;
                return $scope.compile(script, file.name);
            }).catch(function (err) {
                console.error(err);
                $scope.compilingReference = false;
                $scope.compileError = err.toString();
                $scope.$apply();
            }).then(function(result) {
                $scope.compilingReference = false;
                $scope.referenceResult = result;
                $scope.$apply();
            }).catch(function(err) {
                console.error(err);
                $scope.compilingReference = false;
                $scope.compileError = err;
                $scope.$apply();
            });
        }
    });

    /**
     * Listen for file changes to the test files.
     */
    $scope.$watch(function() {return $scope.files; }, function (files) {
        if (files &amp;&amp; files.length > 0) {
            $scope.uploads = [];
            for (var i in files) {
                // encapsulate this scope in a closure to preserve the index
                // variable for each promise
                (function() {
                    var index = i;
                    var p = $scope.readFile(files[index]);
                    // when the file is done being read, update the upload object
                    p.then(function(result) {
                        $scope.uploads[index].done = true;
                        $scope.uploads[index].script = result;
                        // begin compiling this script
                        try {
                            var c = $scope.compile(result, files[index].name);
                            $scope.uploads[index].compilePromise = c;
                            c.then(function(result) {
                                $scope.uploads[index].result = result;
                                $scope.uploads[index].compiled = true;

                                // check against reference script
                                var a = $scope.compare(
                                    $scope.referenceResult, result
                                );
                                if (a) {
                                    $scope.uploads[index].pass = true;
                                };
                            }).catch(function(err) {
                                $scope.uploads[index].error = err.toString();
                                $scope.uploads[index].compiled = true;
                            });
                        } catch (err) {
                            $scope.uploads[index].error = err.toString();
                            $scope.uploads[index].compiled = true;
                        };
                    });
                    // insert the upload object into the list of uploads
                    $scope.uploads.push({
                        'file': files[index],
                        'scriptPromise': p,
                        'script': '',
                        'compilePromise': null,
                        'compiled': false,
                        'result': {},
                        'error': '',
                        'pass': false
                    });
                })();
            }
        }
    });

    /**
     * Function to compare the similarity of two script results.
     */
    $scope.compare = function(reference, test) {

        // sort clips so clips inserted in different orders will not effect
        // equality.
        sortClips(reference);
        sortClips(test);
        // do the same with effects
        sortEffects(reference)
        sortEffects(test)

        return JSON.stringify(reference) == JSON.stringify(test);
    }

    /**
     * Sort the clips in an object by measure.
     */
    function sortClips(result) {
        for (var i in result.tracks) {
            var track = result.tracks[i];
            track.clips.sort(function(a, b) {
                return a.measure - b.measure;
            });
        }
    }

    /**
     * Sort effects by start measure
     *
     * TODO: is this robust? for some reason I doubt it...
     */
    function sortEffects(result) {
        for (var i in result.tracks) {
            var track = result.tracks[i];
            for (var key in track.effects) {
                var effect = track.effects[key];
                effect.sort(function(a, b) {
                    return a.startMeasure - b.startMeasure;
                });
            }
        }
    }


    /**
     * Function to pipe Skulpt's stdout to the EarSketch console.
     *
     * @private
     */
    function outf(text) {
        // For some reason, skulpt prints a newline character after every
        // call to print(), so let's ignore those
        // TODO: users can't print newline characters...ugh
        if (text == '\n') {
            return;
        }
        esconsole('outf text is ' + text, ['INFO', 'IDE']);
        userConsole.log(text);
    }

    /**
     *
     * @private
     */
    function builtinRead(x) {
        if (Sk.builtinFiles === undefined ||
            Sk.builtinFiles["files"][x] === undefined) {

            throw "File not found: '" + x + "'";
        }

        return Sk.builtinFiles["files"][x];
    }

    Sk.configure({output:outf});
    Sk.pre = "output";
    Sk.configure({output:outf,read: builtinRead});

}]);

/**
 * Angular directive for reading files from a file input.
 *
 * Copied from: http://stackoverflow.com/questions/17063000/ng-model-for-input-type-file
 */
app.directive("fileread", [function () {
    return {
        scope: {
            fileread: "="
        },
        link: function (scope, element, attributes) {
            element.bind("change", function (changeEvent) {
                var reader = new FileReader();
                reader.onload = function (loadEvent) {
                    scope.$apply(function () {
                        scope.fileread = loadEvent.target.result;
                    });
                }
                reader.readAsArrayBuffer(changeEvent.target.files[0]);
            });
        }
    }
}]);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-accountController.html">accountController</a></li><li><a href="module-Analyze.html">Analyze</a></li><li><a href="module-apibrowserController.html">apibrowserController</a></li><li><a href="module-audioContext.html">audioContext</a></li><li><a href="module-audioeffects.html">audioeffects</a></li><li><a href="module-audioLibrary.html">audioLibrary</a></li><li><a href="module-autograderController.html">autograderController</a></li><li><a href="module-buildAudioNodeGraph.html">buildAudioNodeGraph</a></li><li><a href="module-changepasswordController.html">changepasswordController</a></li><li><a href="module-ColorPickerCtrl.html">ColorPickerCtrl</a></li><li><a href="module-compiler.html">compiler</a></li><li><a href="module-dawClip.html">dawClip</a></li><li><a href="module-dawClipName.html">dawClipName</a></li><li><a href="module-dawContainerController.html">dawContainerController</a></li><li><a href="module-dawController.html">dawController</a></li><li><a href="module-dawEffect.html">dawEffect</a></li><li><a href="module-dawTimeline.html">dawTimeline</a></li><li><a href="module-dawTrackController.html">dawTrackController</a></li><li><a href="module-DownloadFileCtrl.html">DownloadFileCtrl</a></li><li><a href="module-EarSketchApp.html">EarSketchApp</a></li><li><a href="module-forgotpasswordController.html">forgotpasswordController</a></li><li><a href="module-ideController.html">ideController</a></li><li><a href="module-JavascriptAPI.html">JavascriptAPI</a></li><li><a href="module-mainController.html">mainController</a></li><li><a href="module-NativeJavascriptAPI.html">NativeJavascriptAPI</a></li><li><a href="module-Passthrough.html">Passthrough</a></li><li><a href="module-pitchshifter.html">pitchshifter</a></li><li><a href="module-player.html">player</a></li><li><a href="module-PythonAPI.html">PythonAPI</a></li><li><a href="module-renameController.html">renameController</a></li><li><a href="module-renderer.html">renderer</a></li><li><a href="module-ReportErrorCtrl.html">ReportErrorCtrl</a></li><li><a href="module-SaveScriptCtrl.html">SaveScriptCtrl</a></li><li><a href="module-uploader.html">uploader</a></li><li><a href="module-userConsole.html">userConsole</a></li><li><a href="module-userNotification.html">userNotification</a></li><li><a href="module-WaveforrmCache.html">WaveforrmCache</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addESTagToLog">addESTagToLog</a></li><li><a href="global.html#addESTagToNotLog">addESTagToNotLog</a></li><li><a href="global.html#addESTagToNotPrint">addESTagToNotPrint</a></li><li><a href="global.html#addESTagToPrint">addESTagToPrint</a></li><li><a href="global.html#esconsole">esconsole</a></li><li><a href="global.html#ESLog">ESLog</a></li><li><a href="global.html#formatResultForTests">formatResultForTests</a></li><li><a href="global.html#formatScriptForTests">formatScriptForTests</a></li><li><a href="global.html#getURLParameters">getURLParameters</a></li><li><a href="global.html#ServiceWrapper">ServiceWrapper</a></li><li><a href="global.html#setESConsoleTraceLevel">setESConsoleTraceLevel</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.3</a> on Thu Feb 11 2016 16:06:08 GMT-0500 (EST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
