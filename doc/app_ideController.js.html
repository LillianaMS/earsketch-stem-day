<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app/ideController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app/ideController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Angular controller for the IDE (text editor) and surrounding items.
 * @module ideController
 */
app.controller("ideController", ['$rootScope', '$scope', '$http', '$uibModal', '$location', '$timeout', 'WaveformCache', 'compiler', 'renderer', 'uploader', 'userProject', 'userConsole', 'userNotification', function($rootScope, $scope,$http,$uibModal, $location, $timeout, WaveformCache, compiler, renderer, uploader, userProject, userConsole, userNotification) {

    var TEMPLATES = {
        python: '#\t\tpython code\n#\t\tscript_name:\n#\n'
        + '#\t\tauthor:\n#\t\tdescription:\n#\n\n'
        + 'from earsketch import * \n\n'
        + 'init() \n'
        + 'setTempo(120) \n\n\n\n'
        + 'finish() \n',

        javascript: '//\t\tjavascript code\n//\t\tscript_name:\n//'
        + '\n//\t\tauthor:\n//\t\tdescription:\n//\n\n'
        + 'init(); \n'
        + 'setTempo(120); \n\n\n\n'
        + 'finish(); \n'
    };

    $scope.scriptName = 'untitled';
    $scope.projectId = '';
    $scope.shareLink = false;
    $scope.shareDisabled = false;
    $scope.flagNewScript=false;
    $scope.scriptExtension = '.py';
    $scope.fontSizNum = 14;

    // for report error
    $scope.userName = '';
    $scope.userEmail = '';
    $scope.errorDesc = '';

    $scope.syntaxHighlighting = ['monokai', 'default'];
    $scope.currTheme = 0;

    $scope.maxTabs = 15;

    $scope.active = 0; // the index of the current active tab

    $scope.editor = null;

    $scope.loaded = true; // shows spinning icon when false

    $scope.currentLanguage = 'python';
    $scope.tabs = [
        {
            id: 0,
            timestamp: new Date().getTime().toString(),
            name: "untitled" + $scope.scriptExtension,
            extension: $scope.scriptExtension,
            active: true,
            script: TEMPLATES[$scope.currentLanguage],
            unsaved: true
        }
    ];

    if (localStorage['tabs'] != null) {
        $scope.tabs = JSON.parse(localStorage['tabs']);
    }
    if (localStorage['language'] != null) {
        $scope.currentLanguage = localStorage['language'];
    }


    $scope.$on('updateConsole', function() {
        $scope.$applyAsync(function () {
            $scope.logs = userConsole.getLogs();
        });
    });

    /**
     * Function to run when digest cycle completes. Approach for running jquery or doing any necessary DOM manipulation.
     *
     * @private
     */
    function postDigest(callback){
        var unregister = $rootScope.$watch(function(){
        unregister();
        $timeout(function(){
          callback();
          postDigest(callback);
        },0,false);
      });
    }

    postDigest(function(){
        $('.nav-tabs').tabdrop('layout');
    })

    /**
     * Function to pipe Skulpt's stdout to the EarSketch console.
     *
     * @private
     */
    function outf(text) {
        // For some reason, skulpt prints a newline character after every
        // call to print(), so let's ignore those
        // TODO: users can't print newline characters...ugh
        if (text == '\n') {
            return;
        }
        esconsole('outf text is ' + text, ['INFO', 'IDE']);
        userConsole.log(text);
    }

    /**
     *
     * @private
     */
    function builtinRead(x) {
        if (Sk.builtinFiles === undefined ||
            Sk.builtinFiles["files"][x] === undefined) {

            throw "File not found: '" + x + "'";
        }

        return Sk.builtinFiles["files"][x];
    }

    Sk.configure({output:outf});
    Sk.pre = "output";
    Sk.configure({output:outf,read: builtinRead});

    /**
     * Gets the codemirror editor instance, and calls openShare().
     * @name initEditor
     * @function
     */
    $scope.initEditor = function () {
        $scope.editor = ace.edit('code-editor');
        $scope.editor.setOptions({
            mode: 'ace/mode/' + $scope.currentLanguage,
            theme: 'ace/theme/monokai',
            fontSize: $scope.fontSizNum,
            enableBasicAutocompletion: true,
            showPrintMargin: false
        });
        // monitor the editor for changes, and update the tab value
        $scope.editor.getSession().on('change', function () {
            $scope.tabs[$scope.active].script = $scope.editor.getValue();
            // save tabs state
            localStorage['tabs'] = JSON.stringify($scope.tabs);
        });

        $scope.openShare();
    };

    /**
     * @name openShare
     * @function
     */
    $scope.openShare = function () {
        if ($location.search()['sharing']) {
            var id = $location.search()['sharing'];

            var tab = $scope.addTab();
            if (tab !== null) {
                userProject.loadScript($scope, id)
            }

            $location.search('');
        }
    };

    // listen for changes in the share URL
    $scope.$watch(function () {
        return $location.search()['sharing'];
    }, function () {
        $scope.openShare();
    });

    // listen for changes in font size
    $scope.$watch(function () {
        return localStorage.getItem('fontsize');
    }, function () {
        var fontsize = localStorage.getItem('fontsize');
        if (fontsize != null) {
            esconsole('Font Size Loaded ' + fontsize, 'debug');
            $scope.editor.setOptions({fontSize: fontsize + 'px'});
            $scope.fontSizNum = parseInt(fontsize);
        }
    });

    /**
     * Checks the number of open tabs, and adds a new tab accordingly.
     * @name addTab
     * @function
     * @returns {number}
     */
    $scope.addTab = function () {
        if ($scope.tabs.length >= $scope.maxTabs) {
            userNotification.show("You've reached the maximum of " + $scope.maxTabs + " tabs!", 'failure1');
            userConsole.status(ESMessages.idecontroller.maxTabs);
            return null;
        }
        $scope.setAllTabsInactive();

        var id = $scope.tabs.length;
        $scope.tabs.push({
            id: id,
            timestamp: new Date().getTime().toString(),
            name: "untitled" + $scope.scriptExtension,
            extension: $scope.scriptExtension,
            active: true,
            // load the language-specific template code
            script: TEMPLATES[$scope.currentLanguage],
            unsaved: true
        });

        $scope.swapTab(id);
        $scope.setActiveExtension();

        return id;
    };

    /**
     * @name swapTab
     * @function
     * @param id {number}
     */
    $scope.swapTab = function (id) {
        $scope.active = id;
        $scope.setAllTabsInactive();
        $scope.tabs[id].active = true;
        $scope.languageModeSelect($scope.currentLanguage);
        $scope.setActiveExtension();
        $scope.editor.setValue($scope.tabs[id].script, -1);
        // save tabs state
        localStorage['tabs'] = JSON.stringify($scope.tabs);
    };

    /**
     * @name setActiveExtension
     * @function
     */
    $scope.setActiveExtension = function () {
        var tab = $scope.tabs[$scope.active];
        tab.extension = $scope.scriptExtension;
        $scope.scriptName = tab.name.replace(/.([^.]*)$/, '');
        tab.name = tab.name.replace(/.([^.]*)$/, $scope.scriptExtension);
    };

    /**
     * @name setAllTabsInactive
     * @function
     */
    $scope.setAllTabsInactive = function () {
        angular.forEach($scope.tabs, function (tab) {
            tab.active = false;
        });
    };

    /**
     * @name closeTab
     * @function
     * @param id {number}
     */
    $scope.closeTab = function (id) {
        if (confirm('There may be unsaved additions to your script. Are you sure you want to close the tab?')) {
            if ($scope.tabs.length > 1) {
                $scope.setAllTabsInactive();
                $scope.tabs.splice(id, 1);
                $scope.swapTab(Math.max(0, id-1));
            }
        }
    };

    /**
     * @name setLanguage
     * @function
     * @param language {string} 'python' or 'javascript'
     */
    $scope.setLanguage = function (language) {
        if (language.toLowerCase() != $scope.currentLanguage) {
            if (language == 'javascript') {
                $scope.currentLanguage = 'javascript';
                $scope.scriptExtension = '.js';
            }
            else {
                $scope.currentLanguage = 'python';
                $scope.scriptExtension = '.py';
            }
            $scope.editor.getSession().setMode('ace/mode/' + $scope.currentLanguage);
        }
    };

    /**
     * @name pasteCurriculumCode
     * @function
     * @param key {string}
     * @returns {null}
     */
    $scope.pasteCurriculumCode = function (key) {
        EarSketch.analytics.logButtonClickEvent("pasteCurriculumCode");
        var patt = /&lt;[^>]*>/g;
        key = key.replace(patt, "");
        key = _.unescape(key);
        esconsole("paste key" + key, 'debug');

        var newTab = $scope.addTab();

        // ??
        $scope.$apply(function () {
        });
        if (newTab == null)
            return null;

        $scope.editor.setValue(key, -1);
        $scope.editor.focus();
    };

    // function getSelectedRange() {
    //     return {from: $scope.editor.getCursor(true),
    //             to: $scope.editor.getCursor(false) };
    // }

    // function commentSelection() {
    //     var range = getSelectedRange();
    //     esconsole(JSON.stringify(range), 'debug');
    //     result = $scope.editor.uncomment(range.from, range.to);
    //     if(!result)
    //     $scope.editor.blockComment(range.from, range.to);
    // }

    /**
     * Compile the code in the editor for the current language selection.
     * @name getResult
     * @function
     * @returns {Promise} A promise that resolves to the compiled result.
     */
    $scope.getResult = function () {
        if ($scope.currentLanguage == 'python') {
            return compiler.compilePython(
                $scope.editor.getValue(),
                $scope.audioQuality
            );
        } else if ($scope.currentLanguage == 'javascript') {
            return compiler.compileJavascript(
                $scope.editor.getValue(),
                $scope.audioQuality
            );
        }

    };

    /**
     * Compile code in the editor and broadcast the result to all scopes.
     * @name compileCode
     * @function
     */
    $scope.compileCode = function() {
        WaveformCache.clear();

        // TODO: don't use jQuery
        $('#dawContainer').scrollTop(0); //Scroll DAW to top
        if($("#canvas-message").is(":visible")) {
            $("#workspace").show();
            $("#canvas-message").hide();
            $("#sidenav-canvas").addClass("sidenav-button-transparent");
            $("#sidenav-workstation").removeClass("sidenav-button-transparent");
        }

        EarSketch.Global.ExitFlag = true;//assure the exit check variable is ON

        $scope.loaded = false; // show spinning icon

        // check for p5
        var code = $scope.editor.getValue();
        if (code.indexOf('onLoop') > -1) {
            $("#canvas-placeholder-text").hide();
        }
        else {
            $("#canvas-placeholder-text").show();
        }
        if ($scope.currentLanguage == 'javascript'
            &amp;&amp; code.indexOf('onLoop') > -1) {
            esconsole('Compling native javascript for P5');
            var promise = compiler.compileNativeJavascript(
                $scope.editor.getValue(),
                $scope.audioQuality
            );
        } else {
            // not P5
            var promise = $scope.getResult();
        }

        userConsole.clear();
        $scope.clearErrors();
        userConsole.status('Running script...');
        promise.then(function(result) {
            $scope.loaded = true;
            $rootScope.$broadcast('compiled', result);
            // TODO: refactor notifications

            userNotification.show('Script ran successfully! Click the play button to hear your music.', 'success');

            // Small hack -- if a pitchshift is present, it may print the success message after the compilation success message.
            $timeout(function () {
                userConsole.status('Script ran successfully.');
            }, 200);
        }).catch(function(err) {
            esconsole(err, ['ERROR','IDE']);
            $scope.loaded = true;
            userConsole.error(err);
            $scope.highlightError(err);

            userNotification.show('There are one or more errors in your script. Look at the console for details.', 'failure1');
        });
    };

    /**
     * @name highlightError
     * @function
     * @param err {object}
     */
    $scope.highlightError = function (err) {
        if ($scope.currentLanguage == 'javascript') {
            if (err.lineNumber !== undefined) {
                var line = err.lineNumber - 1;
                var aceRange = ace.require('ace/range').Range;
                var range = new aceRange(line, 0, line, 2000);
                $scope.marker = $scope.editor.getSession().addMarker(range, 'error-highlight', "fullLine");
            }
        } else if ($scope.currentLanguage == 'python') {
            if (err.traceback !== undefined &amp;&amp; err.traceback.length > 0) {
                var line = err.traceback[0].lineno - 1;
                var aceRange = ace.require('ace/range').Range;
                var range = new aceRange(line, 0, line, 2000);
                $scope.marker = $scope.editor.getSession().addMarker(range, 'error-highlight', "fullLine");
            }
        }
    };


    /**
     * @name clearErrors
     * @function
     */
    $scope.clearErrors = function() {
        $scope.editor.getSession().removeMarker($scope.marker);
    };

    /**
     * @name toggleSyntaxHighlighting
     * @function
     */
    $scope.toggleSyntaxHighlighting = function () {
        if (!$scope.currTheme) {
            $scope.currTheme = 1;
            //Add default pygment class
            $("#curriculum .curriculum-javascript").addClass('default-pygment');
            $("#curriculum .curriculum-python").addClass('default-pygment');
            $scope.editor.setTheme('ace/theme/chrome');
        } else {
            $scope.currTheme = 0;
            //Remove default pygment class
            $("#curriculum .curriculum-javascript").removeClass('default-pygment');
            $("#curriculum .curriculum-python").removeClass('default-pygment');
            $scope.editor.setTheme('ace/theme/monokai');
        }
    };

    $scope.$watch(function() {
        return document.getElementById('console-frame').scrollHeight;
    }, function() {
        // autoscroll to the bottom of the console
        var c = document.getElementById('console-frame');
        c.scrollTop = c.scrollHeight;
    });

    /**
     * @name setPage
     * @function
     * @param page {number}
     */
    $scope.setPage = function (page) {
        $state.transitionTo(page);
    };

    /**
     * @name printCode
     * @function
     */
    $scope.printCode = function () {
        EarSketch.analytics.logButtonClickEvent("printScript");

        var numlines = $scope.editor.session.getLength();
        esconsole(numlines, 'debug');
        var lineNum = 0;
        var content = $scope.editor.getValue();
        var pri = document.getElementById("ifmcontentstoprint").contentWindow;
        pri.document.open();
        while (lineNum &lt; numlines) {
            content = $scope.editor.session.getLine(lineNum);
            esconsole(content, 'debug');
            pri.document.writeln(lineNum + 1 + "&amp;nbsp &amp;nbsp &amp;nbsp" + content + "&lt;br>");
            lineNum++;
        }

        pri.document.close();
        pri.focus();
        pri.print();
    };

    /**
     * Returns the workspace for the current user
     * @name getWS
     * @function
     */
    $scope.getWS = function () {
        wsapiGetWorkspace(userProject.getUsername());
    };

    /**
     * Saves the current workspace for the user.
     * @name saveWS
     * @function
     */
    $scope.saveWS = function () {
        //wsapiSaveWorkspace(userProject.getUsername()  , ES_WORKSPACE);
        wsapiSendReport('ERROR  REPORTED');
    };

    /**
     * Not sure what this function does.
     * @name selectProject
     * @function
     * @param name {string}
     */
    $scope.selectProject = function (name) {
        esconsole('selectProject ' + name, 'debug');
    };

    /**
     * @name updateFileLabel
     * @function
     * @param name {string}
     */
    $scope.updateFileLabel = function (name) {
        $scope.tabs[$scope.active].name = name;
    };

    // TODO: move to scriptbrowserController
    /**
     * @name selectScript
     * @function
     * @param script
     * @returns {null}
     */
    $scope.selectScript = function (script) {
        var tabId = $scope.addTab();
        if (tabId == null) {
            return null;
        }
        // TODO: what does this do?
        $scope.updateFileLabel(script.name);

        $scope.updateFileLabel(script.name);
        userProject.setCurrentScript(script.name);

        // TODO: just drop the entire script object into the tab
        var tab = $scope.tabs[$scope.active];
        var editor = $scope.editor;
        tab.name = script.name;
        tab.script = script.source_code;
        tab.shareid = script.shareid;
        tab.unsaved = false;
        editor.setValue(tab.script, -1);

        // TODO: replace with helper function
        var ext = tab.name.match(/.[^.]*$/)[0];
        if (ext == '.py') {
            $scope.languageModeSelect('python');
        } else {
            $scope.languageModeSelect('javascript');
        }

        /*
         var tabId = $scope.addTab();
         if(tabId == null){
         return null;
         }
         $scope.updateFileLabel(name);
         */
    };

    /**
     * @name saveLocal
     * @function
     */
    $scope.saveLocal = (function () {
        var a = document.createElement("a");
        document.body.appendChild(a);
        a.style = "display: none";
        return function() {
            esconsole('Downloading script locally.', ['DEBUG','IDE']);
            var aFileParts = [$scope.editor.getValue()];
            var codeblob = new Blob(aFileParts, {type: 'text/plain'});
            var filename = $scope.tabs[$scope.active].name;
            var url = window.URL.createObjectURL(codeblob);
            // download the script
            a.href = url;
            a.download = filename;
            a.target = '_blank';
            esconsole('File location: ' + a.href, ['DEBUG','IDE']);
            a.click();
            //window.URL.revokeObjectURL(url);
        }
    })();

    /**
     * @name saveAsWav
     * @function
     */
    $scope.saveAsWav = function () {

        $("#download-loader").show();

        $scope.getResult().then(function (result) {
            renderer.renderWav(result).then(function (blob) {
                var timestamp = Date.now();
                uploader.uploadBlob('esaudio.wav', blob, timestamp)
                    .then(function (result) {
                        esconsole('Ready to download wav file.', ['DEBUG', 'IDE']);

                        var modalInstance = $uibModal.open({
                            templateUrl: 'templates/download-file.html',
                            controller: 'DownloadFileCtrl',
                            resolve: {
                                data: function () {
                                    return result.data;
                                }
                            }
                        });

                        $("#download-loader").hide();

                    }).catch(function (err) {
                    esconsole(err, ['ERROR', 'IDE'])
                    userConsole.error('Error saving to WAV.');
                    $("#download-loader").hide();
                });
            });
        }).catch(function (err) {
            esconsole(err, ['DEBUG', 'IDE']);
            userConsole.error('Error saving to WAV.');
            $("#download-loader").hide();
        });

        EarSketch.analytics.logButtonClickEvent("saveAsWav_CodeEditor");
    };

    /**
     * @name saveAsMP3
     * @function
     */
    $scope.saveAsMP3 = function () {

        $("#download-loader").show();

        $scope.getResult().then(function (result) {
            renderer.renderWav(result).then(function (blob) {
                var timestamp = Date.now();
                uploader.uploadBlob('esaudio.mp3', blob, timestamp)
                    .then(function (result) {
                        esconsole('Ready to download mp3 file.', ['DEBUG', 'IDE']);

                        var modalInstance = $uibModal.open({
                            templateUrl: 'templates/download-file.html',
                            controller: 'DownloadFileCtrl',
                            resolve: {
                                data: function () {
                                    return result.data;
                                }
                            }
                        });

                        $("#download-loader").hide();

                    }).catch(function (e) {
                    esconsole(err, ['ERROR', 'IDE'])
                    userConsole.error('Error saving to MP3.');
                    $("#download-loader").hide();
                });
            });
        }).catch(function (err) {
            esconsole(err, ['DEBUG', 'IDE']);
            userConsole.error('Error saving to MP3.');
            $("#download-loader").hide();
        });

    };

    /**
     * @name saveToRPP
     * @function
     */
    $scope.saveToRPP = function () {

        $("#download-loader").show();

        $scope.getResult().then(function (result) {
            uploader.uploadRPP(result).then(function (result) {
                esconsole('Ready to download RPP file.', ['DEBUG', 'IDE']);

                var modalInstance = $uibModal.open({
                    templateUrl: 'templates/download-file.html',
                    controller: 'DownloadFileCtrl',
                    resolve: {
                        data: function () {
                            return result.data;
                        }
                    }
                });

                $("#download-loader").hide();

            }).catch(function (err) {
                esconsole(err, ['ERROR', 'IDE'])
                userConsole.error('Error saving to RPP.');
                $("#download-loader").hide();
            });
        }).catch(function (err) {
            esconsole(err, ['ERROR', 'IDE']);
            userConsole.error('Error saving to RPP.');
            $("#download-loader").hide();
        });
    };

    /**
     * @name shareToSoundcloud
     * @function
     */
    $scope.shareToSoundcloud = function () {

        esconsole('Requesting SoundCloud Access...', ['DEBUG', 'IDE']);
        SC.connect().then(function () {
            // TODO: move to shareController
            // this part copied from saveAsWav()

            $("#download-loader").show();

            $scope.getResult().then(function (result) {
                renderer.renderWav(result).then(function (blob) {
                    var tab = $scope.tabs[$scope.active];

                    esconsole('Opening SoundCloud modal...');
                    // Open modal to edit soundcloud preferences
                    var modal = $uibModal.open({
                        templateUrl: 'templates/share-project-soundcloud.html',
                        controller: 'soundcloudController',
                        size: 100,
                        resolve: {
                            tab: function () {
                                return tab;
                            },
                            blob: function () {
                                return blob;
                            }
                        }
                    });

                    // callback after modal
                    modal.result.then(function (options) {
                        // on modal accept
                        // do nothing
                    }, function () {
                        // on modal cancel
                        $("#download-loader").hide();
                    });
                });
            }).catch(function (err) {
                esconsole(err, ['DEBUG', 'IDE']);
                $("#download-loader").hide();
            });
        });
    };

    /**
     * @name saveScript
     * @function
     */
    $scope.saveScript = function () {
        EarSketch.analytics.logButtonClickEvent("saveScript");
        $scope.flagNewScript = false;
        var modalInstance = $uibModal.open({
            templateUrl: 'templates/save-script.html',
            controller: 'SaveScriptCtrl',
            scope: $scope,
            resolve: {
                scriptName: function () {
                    return $scope.scriptName;
                }
            }
        });

        modalInstance.result.then(function (newName) {
            var oldName = $scope.scriptName;
            $scope.scriptName = newName;
            esconsole("Updating script name from " + oldName + " to " + $scope.scriptName, "ES_debug", false, true, false);
        }, function () {
            esconsole("Save dialog dismissed.", "ES_debug", false, true, false);
        });
    };

    /**
     * @name languageModeSelect
     * @function
     * @param lang {string} 'python' or 'javascript'
     */
    $scope.languageModeSelect = function (lang) {
        //var scriptName = $('#scriptName').html();
        //var scriptName = $scope.scriptName;

        if (lang == 'python') {
            //$scope.tabs[$scope.active()].name = scriptName.replace(/.(^.*)$/, '.py');
            //$('#scriptName').html(scriptName.replace(/.([^.]*)$/, '.py'));
            $scope.currentLanguage = 'python';
            $scope.scriptExtension = '.py';
            $("#py i").removeClass("glyphicon glyphicon-unchecked").addClass("glyphicon glyphicon-ok-sign");
            $("#js i").removeClass("glyphicon glyphicon-ok-sign").addClass("glyphicon glyphicon-unchecked");

            //Hide javascript and show python code blocks in curriculum
            $("#curriculum .curriculum-javascript").hide();
            $("#curriculum .curriculum-python").show();

            //Hide /show copy buttons
            $(".copy-btn-js").hide();
            $(".copy-btn-py").show();

            //Hide javascript and show python code blocks in curriculum
            $("#curriculum .curriculum-javascript").hide();
            $("#curriculum .curriculum-python").show();

            //Hide /show copy buttons
            $(".copy-btn-js").hide();
            $(".copy-btn-py").show();

        }
        else {
            //$scope.tabs[$scope.active()].name = scriptName.replace(/.(^.*)$/, '.js');
            //$('#scriptName').html(scriptName.replace(/.([^.]*)$/, '.js'));
            $scope.currentLanguage = 'javascript';
            $scope.scriptExtension = '.js';
            $("#js i").removeClass("glyphicon glyphicon-unchecked").addClass("glyphicon glyphicon-ok-sign");
            $("#py i").removeClass("glyphicon glyphicon-ok").addClass("glyphicon glyphicon-unchecked");

            //Hide javascript and show python code blocks in curriculum
            $("#curriculum .curriculum-python").hide();
            $("#curriculum .curriculum-javascript").show();

            //Hide /show copy buttons
            $(".copy-btn-py").hide();
            $(".copy-btn-js").show();
        }

        $scope.setActiveExtension();
        $scope.editor.getSession().setMode('ace/mode/' + $scope.currentLanguage);
        localStorage['language'] = $scope.currentLanguage;
    };

    /**
     * @name codeMode
     * @function
     * @param arg
     */
    $scope.codeMode = function (arg) {
        $scope.currentLanguage = arg;
        $scope.languageModeSelect($scope.currentLanguage);
        $rootScope.$broadcast('language', arg); // language mode used in different controllers
    };

    /**
     * @name newScript
     * @function
     */
    $scope.newScript = function () {
        $scope.flagNewScript = true;
        var modalInstance = $uibModal.open({
            templateUrl: 'templates/save-script.html',
            controller: 'SaveScriptCtrl',
            scope: $scope,
            resolve: {
                scriptName: function () {
                    return $scope.scriptName;
                }
            }
        });
    };

    /**
     * @name reportError
     * @function
     */
    $scope.reportError = function () {

        var modalInstance = $uibModal.open({
            templateUrl: 'templates/report-error.html',
            controller: 'ReportErrorCtrl',
            scope: $scope
        });
    };

    /**
     * @name pasteCode
     * @function
     * @param key
     * @returns {*}
     */
    $scope.pasteCode = function (key) {  // Anand : Modified to paste at cursor position
        EarSketch.analytics.logButtonClickEvent("pasteCode");
        esconsole('paste key ' + key, 'debug');
        $scope.editor.session.getTextRange($scope.editor.getSelectionRange($scope.editor.insert(key)));
        $scope.editor.focus();
        return key;
    };

    /**
     * @name refreshScripts
     * @function
     */
    $scope.refreshScripts = function () {
        esconsole('refreshScripts ....', 'debug');
        userProject.refreshProjects($scope);
    };

    /**
     * @name showEmptyFilename
     * @function
     */
    $scope.showEmptyFilename = function () {
        userNotification.show('Empty file name!', 'failure1');
    };

    /**
     * @name setFontSize
     * @function
     * @param fontSize {number}
     */
    $scope.setFontSize = function (fontSize) {
        esconsole('resizing editor font size to - ' + fontSize, 'debug');
        if (fontSize == 'Default') {
            $scope.editor.setFontSize(fontSize);
            $scope.fontSizNum = 14;
        }
        else {
            $scope.editor.setFontSize(fontSize);
            $scope.fontSizNum = fontSize;
        }
        localStorage.setItem('fontsize', $scope.fontSizNum);
        $scope.editor.focus();
    };

    //Listen for call to uploadModel from soundbrowserController
    $scope.$on('uploadModal', function(event, args) {
            $scope.openUploadWindow()
    });

    /**
     * @name openUploadWindow
     * @function
     */
    $scope.openUploadWindow = function () {
        if (userProject.isLogged()) {
            var modalInstance = $uibModal.open({
                templateUrl: 'templates/upload-sound.html',
                controller: 'UploadSoundCtrl'
            });
        } else {
            if ($scope.logs) {
                $scope.logs.push(ESMessages.general.unauthenticated);
            } else {
                esconsole('trying to add log to $scope.logs which does not exist', 'debug');
            }
            userNotification.show('Please login before using this feature.', 'failure1');
        }
    };

    /**
     * @name openColorPicker
     * @function
     */
    $scope.openColorPicker = function () {
        var modalInstance = $uibModal.open({
            templateUrl: 'templates/color-picker.html',
            controller: 'ColorPickerCtrl',
            windowClass: 'color-picker-modal'
        });
    };

    // empty
    $scope.refreshSoundBrowser = function () {
        // Not sure what this does -- Anand 05/05/2015
//       console.log(JSAudioList['essynthz'].location);
//       console.log(JSAudioList['essynthz'].tempo);
        //sbInit();
    };

    /**
     * @name loadCustomSounds
     * @function
     */
    $scope.loadCustomSounds = function () {
        esconsole('Load Custom Sounds', 'debug');
        userProject.fillCustomSounds();
    };

    /*
    var  loadState = function (){
        console.log('*************loading state code...');
        var jsstate = localStorage.getItem('userstate');
        if(jsstate!=null){
            console.log('current state code '+jsstate);
            var userState = JSON.parse(jsstate);
            if((userState.sourcecode!=null)&amp;&amp;(userState.sourcecode.length>5) ){
                console.log('inside current state code '+jsstate);
                editor.setValue(userState.sourcecode);
            }
        }
    }

    loadState();*/

}]);

app.directive('fileModel', ['$parse', function ($parse) {
    return {
        restrict: 'A',
        link: function(scope, element, attrs) {

            var model = $parse(attrs.fileModel);
            var modelSetter = model.assign;

            element.bind('change', function(){
                scope.$apply(function(){
                    modelSetter(scope, element[0].files[0]);
                });
            });
        }
    };
}]);

/**
 * @module SaveScriptCtrl
 */
app.controller('SaveScriptCtrl', function($scope,$http,$modalInstance,scriptName) {

    $scope.scriptName = (scriptName === 'undefined.py' ? '' : scriptName);
    $scope.oldName = (scriptName === 'undefined.py' ? '' : scriptName);

    /**
     * @name save
     * @function
     * @param newName {string}
     */
    $scope.save = function (newName) {
        //TODO: actually save the file
        var flagerr = false;
        var parseName = newName.replace(/[^\.a-zA-Z0-9]/g, '_');
        esconsole('Parsed Name:' + parseName, 'debug');
        try {
            if (typeof(parseName) == 'undefined') {
                $scope.logs.push('Undefined ' + ESMessages.general.invalidname);
                flagerr = true;
            } else {
                var jsstr = parseName + '=5';
                esconsole(jsstr, 'debug');
                eval(jsstr);
            }
        }
        catch (err) {
            flagerr = true;
            $scope.logs.push(parseName + ' ' + ESMessages.general.invalidname);
        }

        if ((!flagerr) &amp;&amp; (parseName.length &lt; 3)) {
            flagerr = true;
            $scope.logs.push(parseName + ' ' + ESMessages.general.invalidname);
        }

        // check if we are overwriting a saved script with the same name
        var oldName = $scope.tabs[$scope.active].name;
        var unsaved = $scope.tabs[$scope.active].unsaved;
        var overwrite = false; // assume we're not

        // only do this if this script is unsaved or the name has changed
        if (unsaved || oldName != newName + $scope.scriptExtension) {
            // check every saved script
            for (var i = 0; i &lt; $scope.scripts.length; i++) {
                var s = $scope.scripts[i];
                if (s.name == newName + $scope.scriptExtension) {
                    overwrite = true;
                    break;
                }
            }
        }

        if (overwrite) {
            if (!confirm("You are about to overwrite a script with the same name.\n"
                         + "Are you sure you want to do that?")) {
                return;
            }
        }

        if (!flagerr) {
            $scope.scriptName = parseName + $scope.scriptExtension;
            userProject.setCurrentScript($scope.scriptName);
            userProject.saveSourceCode($scope.editor.getValue());
            $scope.updateFileLabel($scope.scriptName);
            // set the unsaved flag to false
            $scope.tabs[$scope.active].unsaved = false;
        } else {
            //$scope.showEmptyFilename();
        }
        $modalInstance.close(parseName);
    };

    /**
     * @name cancel
     * @function
     */
    $scope.cancel = function () {
        $modalInstance.dismiss('cancel');
    };

    /**
     * @name new
     * @function
     */
    $scope.new = function () {
        $scope.addTab();
        // $scope.languageModeSelect($scope.currentLanguage);
        // $scope.initEditor(true);
        userProject.setCurrentScript(null);
        $modalInstance.close();
    };
});

/**
 * @module DownloadFileCtrl
 */
app.controller('DownloadFileCtrl', function($scope,$modalInstance,data) {

    $scope.data = data;

    /**
     * Closes the modal instance.
     * @name cancel
     * @function
     */
    $scope.cancel = function() {
        $modalInstance.dismiss('cancel');
    }
});

/**
 * @module ReportErrorCtrl
 */
app.controller('ReportErrorCtrl', function($scope,$http,$modalInstance) {
    /**
     * Closes the modal instance.
     * @name cancel
     * @function
     */
    $scope.cancel = function () {
        $modalInstance.dismiss('cancel');
        esconsole('Clicked cancel', 'debug');
        esconsole('clicked cancel', 'user', 0);
    };

    /**
     * @name sendError
     * @function
     * @param userName {string}
     * @param userEmail {string}
     * @param errorDesc {string}
     */
    $scope.sendError = function (userName, userEmail, errorDesc) {

        esconsole('Clicked send', 'debug');
        esconsole(userName);
        esconsole(userEmail);
        esconsole(errorDesc);
        esconsole("Source code " + $scope.editor.getValue());
        esconsole("Console trace " + JSON.stringify(REPORT_LOG.slice(-100)));

        var errorlog = {};
        errorlog.usermail = userEmail;
        errorlog.username = userName;
        errorlog.description = errorDesc;
        errorlog.sourcecode = '```' + $scope.editor.getValue() + '```';
        errorlog.tracelog = REPORT_LOG.slice(-100); //bug# 722 fix - Avrosh
        /*
         * TODO: this is trello formatting, does it work better?
         var report = '';
         report += 'User Information';
         report += '================';
         report += '**User email:** ' + userEmail;
         report += '**Username:** ' + userName;
         report += 'Description of Error';
         report += '====================';
         report += 'Source Code';
         report += '===========';
         report += '```'+$scope.editor.getValue()+'```';
         report += 'Console Log (Last 100 Logs)';
         report += '===========================';
         report += '```'+REPORT_LOG.slice(-100).join('\n')+'```';
         */
        wsapiSendReport(JSON.stringify(errorlog)); //bug# 722 fix - Avrosh

        //$('#mine').html("Thank you for your input, we'll get back to you with a solution soon!");
        //$('#errDetails').remove();
        //$('.modal-footer').remove();

        setTimeout(func, 1000);
        function func() {
            $modalInstance.close();
        }
    };
});

/**
 * @module ColorPickerCtrl
 */
app.controller('ColorPickerCtrl', function($scope,$http,$modalInstance) {
    /**
     * @name initColorPicker
     * @function
     */
    $scope.initColorPicker = function () {
        $('.modal-backdrop').removeClass("modal-backdrop");
        $('#colorPicker').colpick({
            flat: true,
            layout: 'hex',
            colorScheme: 'dark',
            submit: 1,
            onSubmit: function (hsb, hex, rgb, el, bySetColor) {
                pasteColor('"#' + hex + '"');
            }
        });
    };

    /**
     * Closes the modal instance.
     * @name close
     * @function
     */
    $scope.close = function () {
        $modalInstance.close();
    };
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-accountController.html">accountController</a></li><li><a href="module-Analyze.html">Analyze</a></li><li><a href="module-apibrowserController.html">apibrowserController</a></li><li><a href="module-audioContext.html">audioContext</a></li><li><a href="module-audioeffects.html">audioeffects</a></li><li><a href="module-audioLibrary.html">audioLibrary</a></li><li><a href="module-autograderController.html">autograderController</a></li><li><a href="module-buildAudioNodeGraph.html">buildAudioNodeGraph</a></li><li><a href="module-changepasswordController.html">changepasswordController</a></li><li><a href="module-ColorPickerCtrl.html">ColorPickerCtrl</a></li><li><a href="module-compiler.html">compiler</a></li><li><a href="module-dawClip.html">dawClip</a></li><li><a href="module-dawClipName.html">dawClipName</a></li><li><a href="module-dawContainerController.html">dawContainerController</a></li><li><a href="module-dawController.html">dawController</a></li><li><a href="module-dawEffect.html">dawEffect</a></li><li><a href="module-dawTimeline.html">dawTimeline</a></li><li><a href="module-dawTrackController.html">dawTrackController</a></li><li><a href="module-DownloadFileCtrl.html">DownloadFileCtrl</a></li><li><a href="module-EarSketchApp.html">EarSketchApp</a></li><li><a href="module-forgotpasswordController.html">forgotpasswordController</a></li><li><a href="module-ideController.html">ideController</a></li><li><a href="module-JavascriptAPI.html">JavascriptAPI</a></li><li><a href="module-mainController.html">mainController</a></li><li><a href="module-NativeJavascriptAPI.html">NativeJavascriptAPI</a></li><li><a href="module-Passthrough.html">Passthrough</a></li><li><a href="module-pitchshifter.html">pitchshifter</a></li><li><a href="module-player.html">player</a></li><li><a href="module-PythonAPI.html">PythonAPI</a></li><li><a href="module-renameController.html">renameController</a></li><li><a href="module-renderer.html">renderer</a></li><li><a href="module-ReportErrorCtrl.html">ReportErrorCtrl</a></li><li><a href="module-SaveScriptCtrl.html">SaveScriptCtrl</a></li><li><a href="module-uploader.html">uploader</a></li><li><a href="module-userConsole.html">userConsole</a></li><li><a href="module-userNotification.html">userNotification</a></li><li><a href="module-WaveforrmCache.html">WaveforrmCache</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addESTagToLog">addESTagToLog</a></li><li><a href="global.html#addESTagToNotLog">addESTagToNotLog</a></li><li><a href="global.html#addESTagToNotPrint">addESTagToNotPrint</a></li><li><a href="global.html#addESTagToPrint">addESTagToPrint</a></li><li><a href="global.html#esconsole">esconsole</a></li><li><a href="global.html#ESLog">ESLog</a></li><li><a href="global.html#formatResultForTests">formatResultForTests</a></li><li><a href="global.html#formatScriptForTests">formatScriptForTests</a></li><li><a href="global.html#getURLParameters">getURLParameters</a></li><li><a href="global.html#ServiceWrapper">ServiceWrapper</a></li><li><a href="global.html#setESConsoleTraceLevel">setESConsoleTraceLevel</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.3</a> on Thu Feb 11 2016 16:06:08 GMT-0500 (EST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
