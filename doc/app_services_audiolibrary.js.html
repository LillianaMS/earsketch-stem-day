<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app/services/audiolibrary.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app/services/audiolibrary.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * An Angular factor service for fetching audio clips from the EarSketch
 * library.
 *
 * TODO: Angular $http uses Angular $q promises, which are not compatible with
 * native ECMAScript 6 Promises. Maybe one day they will be? I.e.
 * $q.all() and Promise.all() will not let you interchange promise types. At
 * least in unit tests. It seems to work in the browser. I have no idea why.
 * I used $q everywhere in this library so we could unit test this service.
 *
 * @module audioLibrary
 * @author Creston Bunch
 */
app.factory('audioLibrary', ['$http', 'audioContext', '$q',
function audioLibraryFactory($http, ctx, $q) {

    var CLIP_CACHE = {};
    var PROMISE_CACHE = {};

    // TODO: don't hardcode these lists
    var JSEffectKeys =
    ["VOLUME","GAIN","DELAY","DELAY_TIME","DELAY_FEEDBACK",
    "DISTORTION","DISTO_GAIN","FILTER","FILTER_FREQ","FILTER_RESONANCE",
    "COMPRESSOR","COMPRESSOR_THRESHOLD","COMPRESSOR_RATIO","PAN","LEFT_RIGHT",
    "BANDPASS","BANDPASS_FREQ","BANDPASS_WIDTH","CHORUS","CHORUS_LENGTH",
    "CHORUS_NUMVOICES","CHORUS_RATE","CHORUS_MOD","EQ3BAND","EQ3BAND_LOWGAIN",
    "EQ3BAND_LOWFREQ","EQ3BAND_MIDGAIN","EQ3BAND_MIDFREQ","EQ3BAND_HIGHGAIN",
    "EQ3BAND_HIGHFREQ","FLANGER","FLANGER_LENGTH","FLANGER_FEEDBACK",
    "FLANGER_RATE","PHASER","PHASER_RATE","PHASER_RANGEMIN","PHASER_RANGEMAX",
    "PHASER_FEEDBACK","PITCHSHIFT","PITCHSHIFT_SHIFT","TREMOLO","TREMOLO_FREQ",
    "TREMOLO_AMOUNT","RINGMOD","RINGMOD_MODFREQ","RINGMOD_FEEDBACK","WAH",
    "WAH_POSITION","REVERB","REVERB_TIME","REVERB_DAMPFREQ","MIX","BYPASS"];
    var JSAnalysisKeys = ["SPECTRAL_CENTROID", "RMS_AMPLITUDE"];

    /**
     * Get an audio buffer from a file key.
     *
     * @param {string} filekey The constant associated with the audio clip that
     * users type in EarSketch code.
     * @param {int} tempo Tempo to scale the returned clip to.
     * @param {int} quality 0 is high quality 1 is low quality
     * @returns {Promise} A promise that resolves to an arraybuffer
     */
    function getAudioClip(filekey, tempo, quality) {

        var cacheKey = [];
        for (var i = 0; i &lt; arguments.length; i++) {
            cacheKey.push(arguments[i]);
        }

        if (cacheKey in CLIP_CACHE) {
            // this clip has already been downloaded
            return $q(function(resolve, reject) {
                resolve(CLIP_CACHE[cacheKey]);
            });
        } else if (cacheKey in PROMISE_CACHE) {
            // this clip is currently in the process of being downloaded
            return PROMISE_CACHE[cacheKey];
        } else {
            esconsole('Loading audio clip with filekey: ' + filekey,
                      ['DEBUG', 'AUDIOLIBRARY']);
            var url = URL_LOADAUDIO;

            // STEP 1: check if audio key exists
            var p = getUserAudioTags().then(function(result) {
                if (result.indexOf(filekey) === -1) {
                    throw new ReferenceError(
                        'File key ' + filekey + ' does not exist'
                    );
                }
                return result;
            }).catch(function(err) {
                esconsole('Error getting audio keys: ' + filekey,
                          ['ERROR', 'AUDIOLIBRARY']);
                throw err;

            // STEP 2: Ask the server for the audio file
            }).then(function(result) {
                esconsole(
                    'Getting ' + filekey + ' buffer from server ',
                    ['DEBUG', 'AUDIOLIBRARY']
                );
                return $http.get(url, {
                    params: {
                        key: filekey,
                        tempo: tempo,
                        audioquality: quality ? 1 : 0
                    },
                    responseType: 'arraybuffer'
                });
            }).catch(function(err) {
                esconsole('Error getting ' + filekey + ' from the server',
                          ['ERROR', 'AUDIOLIBRARY']);
                throw err;

            // STEP 3: decode the audio data.
            }).then(function(result) {
                // TODO: use promise-based syntax for decodeAudioData() once
                // browsers start supporting it
                esconsole('Decoding ' + filekey + ' buffer',
                          ['DEBUG', 'AUDIOLIBRARY']);
                return $q(function(resolve, reject) {
                    ctx.decodeAudioData(result.data, function (buffer) {
                        esconsole(
                            filekey + ' buffer decoded',
                            ['DEBUG', 'AUDIOLIBRARY']
                        );
                        resolve(buffer);
                    }, function(err) {
                        esconsole('Error', ['ERROR','AUDIOLIBRARY']);
                        reject(err);
                    });
                });
            }).catch(function(err) {
                esconsole('Error decoding audio clip: ' + filekey,
                          ['ERROR', 'AUDIOLIBRARY']);
                throw err;

            // STEP 4: return the decoded audio buffer
            }).then(function(buffer) {
                CLIP_CACHE[cacheKey] = buffer;
                // add a filekey property to the buffer so we can
                // figure out where it came from later
                buffer.filekey = filekey;
                // remove this promise from the cache since it's
                // been resolved
                delete PROMISE_CACHE[cacheKey];

                esconsole('Returning buffer', ['DEBUG','AUDIOLIBRARY']);
                return buffer;
            }).catch(function(err) {
                esconsole('Error getting audio clip: ' + filekey,
                          ['ERROR', 'AUDIOLIBRARY']);
                throw err;
            });
            // add this promise to the list of currently running promises so
            // we don't make another HTTP request if one is already underway
            // TODO: is this functionality duplicated by CLIP_CACHE?
            PROMISE_CACHE[cacheKey] = p;
            return p;
        }
    }

    /**
     * Get the list of audio tag names.
     *
     * @returns {Promise} A promise that resolves to the list of audio tags.
     */
    function getAudioTags() {
        var url = URL_DOMAIN + '/services/audio/getaudiotags';
        esconsole('Fetching audio tags', ['DEBUG','AUDIOLIBRARY']);
        return $http.get(url, {cache: true})
        .then(function(result) {
            // return only a list of file keys
            var output = []
            for (var key in result.data.audioTags) {
                var tag = result.data.audioTags[key];
                output.push(tag.file_key);
            }
            esconsole('Found audio tags', ['DEBUG','AUDIOLIBRARY']);
            return output;
        }).catch(function(err) {
            esconsole(err, ['ERROR','AUDIOLIBRARY']);
            throw err;
        });
    }

    /**
     * Get the list of (every-)user-submitted audio tags.
     *
     * @returns {Promise} A promise that resolves to the list of audio keys.
     */
    function getUserAudioTags() {
        var url = URL_DOMAIN + '/services/audio/getaudiokeys?tag=';
        esconsole('Fetching audio keys', ['DEBUG','AUDIOLIBRARY']);
        return $http.get(url, {cache: true})
        .then(function(result) {
            // return only a list of file keys
            var output = [];
            for (var key in result.data.audioFiles) {
                var tag = result.data.audioFiles[key];
                output.push(tag.file_key);
            }
            esconsole('Found audio keys', ['DEBUG','AUDIOLIBRARY']);
            return output;
        }).catch(function(err) {
            esconsole(err, ['ERROR','AUDIOLIBRARY']);
            throw err;
        });
    }

    /**
     * Get a list of folder keys.
     *
     * @return {Promise} A promise that resolves to the list of folder keys.
     */
    function getAudioFolders() {
        var url = URL_DOMAIN + '/services/audio/getaudiokeys?tag=';
        esconsole('Fetching audio folders', ['DEBUG','AUDIOLIBRARY']);
        return $http.get(url, {cache: true})
        .then(function(result) {
            // return only a list of file keys
            var output = []
            for (var key in result.data.audioFiles) {
                var file = result.data.audioFiles[key];
                if (file.scope === 0) { continue; }
                var str = file.tags.toUpperCase();
                var tokens = str.split('__');
                // TODO: this token business is confusing
                output.push(tokens[0]);
                output.push(tokens[tokens.length-1]);
                output.push(str.substr(str.indexOf('__')+2, str.length));
            }
            esconsole('Found audio folders', ['DEBUG','AUDIOLIBRARY']);
            return output;
        }).catch(function(err) {
            esconsole(err, ['ERROR','AUDIOLIBRARY']);
            throw err;
        });
    }

    /**
     * Get the list of effect constants.
     *
     * TODO: don't hardcode this list.
     *
     * @returns {Promise} A promise that resolves to the list of effect
     * constants.
     */
    function getEffectTags() {
        esconsole('Fetching effect tags', ['DEBUG','AUDIOLIBRARY']);
        return $q(function(resolve, reject) {
            resolve(JSEffectKeys);
            esconsole('Found effect tags', ['DEBUG','AUDIOLIBRARY']);
        });
    }

    /**
     * Get the list of analysis constants.
     *
     * TODO: don't hardcode this list.
     *
     * @return {Promise} A promise that resolves to the list of analysis
     * constants.
     */
    function getAnalysisTags() {
        esconsole('Fetching analysis tags', ['DEBUG','AUDIOLIBRARY']);
        return $q(function(resolve, reject) {
            resolve(JSAnalysisKeys);
            esconsole('Found analysis tags', ['DEBUG','AUDIOLIBRARY']);
        });
    }

    /**
     * Get a list of all audio/effect/analysis constants.
     *
     * @returns {Promise} A promise that resolves to a list of all EarSketch
     * constants.
     */
    function getAllTags() {
        esconsole('Fetching all tags', ['DEBUG','AUDIOLIBRARY']);
        return $q.all([
            getAudioTags(),
            getEffectTags(),
            getAnalysisTags(),
            getAudioFolders(),
            getUserAudioTags()
        ]).then(function(result) {
            // wait for all promises to complete and concatenate their results
            esconsole('Fetched all tags.', ['DEBUG','AUDIOLIBRARY']);
            return result[0].concat(result[1], result[2], result[3], result[4]);
        }, function(err) {
            esconsole(err, ['ERROR','AUDIOLIBRARY']);
            throw err;
        }).catch(function(err) {
            esconsole(err, ['ERROR','AUDIOLIBRARY']);
            throw err;
        });
    }

    return {
        getAudioClip: getAudioClip,
        getAudioTags: getAudioTags,
        getUserAudioTags: getUserAudioTags,
        getAudioFolders: getAudioFolders,
        getEffectTags: getEffectTags,
        getAnalysisTags: getAnalysisTags,
        getAllTags: getAllTags
    }

}]);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-accountController.html">accountController</a></li><li><a href="module-Analyze.html">Analyze</a></li><li><a href="module-apibrowserController.html">apibrowserController</a></li><li><a href="module-audioContext.html">audioContext</a></li><li><a href="module-audioeffects.html">audioeffects</a></li><li><a href="module-audioLibrary.html">audioLibrary</a></li><li><a href="module-autograderController.html">autograderController</a></li><li><a href="module-buildAudioNodeGraph.html">buildAudioNodeGraph</a></li><li><a href="module-changepasswordController.html">changepasswordController</a></li><li><a href="module-ColorPickerCtrl.html">ColorPickerCtrl</a></li><li><a href="module-compiler.html">compiler</a></li><li><a href="module-dawClip.html">dawClip</a></li><li><a href="module-dawClipName.html">dawClipName</a></li><li><a href="module-dawContainerController.html">dawContainerController</a></li><li><a href="module-dawController.html">dawController</a></li><li><a href="module-dawEffect.html">dawEffect</a></li><li><a href="module-dawTimeline.html">dawTimeline</a></li><li><a href="module-dawTrackController.html">dawTrackController</a></li><li><a href="module-DownloadFileCtrl.html">DownloadFileCtrl</a></li><li><a href="module-EarSketchApp.html">EarSketchApp</a></li><li><a href="module-forgotpasswordController.html">forgotpasswordController</a></li><li><a href="module-ideController.html">ideController</a></li><li><a href="module-JavascriptAPI.html">JavascriptAPI</a></li><li><a href="module-mainController.html">mainController</a></li><li><a href="module-NativeJavascriptAPI.html">NativeJavascriptAPI</a></li><li><a href="module-Passthrough.html">Passthrough</a></li><li><a href="module-pitchshifter.html">pitchshifter</a></li><li><a href="module-player.html">player</a></li><li><a href="module-PythonAPI.html">PythonAPI</a></li><li><a href="module-renameController.html">renameController</a></li><li><a href="module-renderer.html">renderer</a></li><li><a href="module-ReportErrorCtrl.html">ReportErrorCtrl</a></li><li><a href="module-SaveScriptCtrl.html">SaveScriptCtrl</a></li><li><a href="module-uploader.html">uploader</a></li><li><a href="module-userConsole.html">userConsole</a></li><li><a href="module-userNotification.html">userNotification</a></li><li><a href="module-WaveforrmCache.html">WaveforrmCache</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addESTagToLog">addESTagToLog</a></li><li><a href="global.html#addESTagToNotLog">addESTagToNotLog</a></li><li><a href="global.html#addESTagToNotPrint">addESTagToNotPrint</a></li><li><a href="global.html#addESTagToPrint">addESTagToPrint</a></li><li><a href="global.html#esconsole">esconsole</a></li><li><a href="global.html#ESLog">ESLog</a></li><li><a href="global.html#formatResultForTests">formatResultForTests</a></li><li><a href="global.html#formatScriptForTests">formatScriptForTests</a></li><li><a href="global.html#getURLParameters">getURLParameters</a></li><li><a href="global.html#ServiceWrapper">ServiceWrapper</a></li><li><a href="global.html#setESConsoleTraceLevel">setESConsoleTraceLevel</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.3</a> on Thu Feb 11 2016 16:06:08 GMT-0500 (EST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
