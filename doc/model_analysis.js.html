<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: model/analysis.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: model/analysis.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// We need to keep track of the calls to the analysis APIs as we need to schedule them to be called after finish()
// The reason being, the audio buffers would not have been loaded before that and the analysis would fail.
/**
 * @fileOverview Global analysis functions
 * @module Analyze
 */

/**
 * @name computeFeatureForBuffer
 * @function
 * @param buffer {object}
 * @param funcPointerToFeature {function}
 * @param tempo {number}
 * @param startTime {number}
 * @param endTime {number}
 * @returns {number}
 */
function computeFeatureForBuffer(buffer, funcPointerToFeature, tempo, startTime, endTime) {
	var data;
	var temp = [];
	var spectrum;
	var featureValue;
	var featureVector = [];
	data = buffer.getChannelData(0);
	var startTimeInSamples = 0;
	var endTimeInSamples = data.length;
	var blockSize = 2048;
	// If we are analyzing one part of the clip. If end time is not specified, we analyze till the end
	if (startTime != undefined) {
		startTimeInSamples = Math.round(buffer.sampleRate * ESUtilsMeasureToTime(startTime, tempo));
		if (endTime != undefined) {
			endTimeInSamples = Math.round(buffer.sampleRate * ESUtilsMeasureToTime(endTime, tempo));
		}
	}

	// extract data according to start and end time
	for (var k = 0; k &lt; endTimeInSamples - startTimeInSamples; k++) {
		temp[k] = data[k + startTimeInSamples];
	}

	// Simple playback with analyser node
	var fft = new FFT(blockSize,buffer.sampleRate);
	var hann = new WindowFunction(DSP.HANN);

	var hop = 0;
	while ((hop + blockSize) &lt; temp.length) {
		// First get the magnitude spectrum for each block
		fft.forward(hann.process(temp.slice(hop,hop+blockSize)));
		spectrum = fft.spectrum;
		featureValue = window[funcPointerToFeature](temp.slice(hop,hop+blockSize),spectrum, buffer.sampleRate, blockSize);
		featureVector.push(featureValue);
		hop += blockSize;
	}
	featureVector.sort();
	// We take the median as the appropriate value
	return (featureVector[Math.floor(featureVector.length/2)]);
}

// This routine computes the feature for 1 Block only!
function compute_spectral_centroid(time_domain_signal, spectrum, fs, blockSize)
{
	var amplitude_sum = 0;
	var weighted_bin_sum = 0;
	var centroid;
	for (var index = 0; index &lt; spectrum.length; index ++) {
		weighted_bin_sum += (index+1)*spectrum[index];
		amplitude_sum += spectrum[index];
	}

	if (amplitude_sum != 0) {
		centroid = weighted_bin_sum/amplitude_sum;
	} else {
		centroid = 0;
	}
	// normalize it by fs/2 as that is the maximum frequency that can exist in the spectrum.
	// The result is fitted to scale between 0 and 1.

	centroid = centroid / (blockSize/2);
	return centroid;
}

// This routine computes the feature for 1 Block only!
function compute_rms_amplitude(time_domain_signal, spectrum, fs, blockSize) {
	var amplitudeSquare = 0;
	var squareSum = 0;
	var rms;
	for (var index = 0; index &lt; time_domain_signal.length; index ++) {
		amplitudeSquare = time_domain_signal[index]*time_domain_signal[index];
		squareSum += amplitudeSquare
	}

	if (time_domain_signal.length != 0) {
		rms = Math.sqrt(squareSum/time_domain_signal.length);
	} else {
		rms = 0;
	}

	// The result is fitted to scale between 0 and 1.
	return rms;
}

/**
 * @name ESAnalyze
 * @function
 * @param buffer {object}
 * @param featureForAnalysis {string}
 * @param tempo {number}
 * @returns {number}
 */
function ESAnalyze(buffer, featureForAnalysis, tempo) {
	var featureValue;
	featureValue = computeFeatureForBuffer(buffer, 'compute_'+ featureForAnalysis.toLowerCase(), tempo);
	return featureValue;
}

/**
 * @name ESAnalyzeForTime
 * @function
 * @param buffer {object}
 * @param featureForAnalysis {string}
 * @param startTime {number}
 * @param endTime {number}
 * @param tempo {number}
 * @returns {number}
 */
function ESAnalyzeForTime(buffer, featureForAnalysis, startTime, endTime, tempo) {
	var buffLengthMeasures = ESUtilsTimeToMeasure(buffer.duration,tempo);
	var featureValue;
	featureValue = computeFeatureForBuffer(buffer, 'compute_'+ featureForAnalysis.toLowerCase(), tempo, startTime, endTime);
	return featureValue;
}

/**
 * @name ESDur
 * @function
 * @param buffer {object}
 * @param tempo {number}
 * @returns {number}
 */
function ESDur(buffer, tempo) {
	// rounds off precision error in JS
	var digits = 2;
	return Math.round(ESUtilsTimeToMeasure(buffer.duration, tempo) * Math.pow(10, digits)) / Math.pow(10, digits);
}



</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-accountController.html">accountController</a></li><li><a href="module-Analyze.html">Analyze</a></li><li><a href="module-apibrowserController.html">apibrowserController</a></li><li><a href="module-audioContext.html">audioContext</a></li><li><a href="module-audioeffects.html">audioeffects</a></li><li><a href="module-audioLibrary.html">audioLibrary</a></li><li><a href="module-autograderController.html">autograderController</a></li><li><a href="module-buildAudioNodeGraph.html">buildAudioNodeGraph</a></li><li><a href="module-changepasswordController.html">changepasswordController</a></li><li><a href="module-ColorPickerCtrl.html">ColorPickerCtrl</a></li><li><a href="module-compiler.html">compiler</a></li><li><a href="module-dawClip.html">dawClip</a></li><li><a href="module-dawClipName.html">dawClipName</a></li><li><a href="module-dawContainerController.html">dawContainerController</a></li><li><a href="module-dawController.html">dawController</a></li><li><a href="module-dawEffect.html">dawEffect</a></li><li><a href="module-dawTimeline.html">dawTimeline</a></li><li><a href="module-dawTrackController.html">dawTrackController</a></li><li><a href="module-DownloadFileCtrl.html">DownloadFileCtrl</a></li><li><a href="module-EarSketchApp.html">EarSketchApp</a></li><li><a href="module-forgotpasswordController.html">forgotpasswordController</a></li><li><a href="module-ideController.html">ideController</a></li><li><a href="module-JavascriptAPI.html">JavascriptAPI</a></li><li><a href="module-mainController.html">mainController</a></li><li><a href="module-NativeJavascriptAPI.html">NativeJavascriptAPI</a></li><li><a href="module-Passthrough.html">Passthrough</a></li><li><a href="module-pitchshifter.html">pitchshifter</a></li><li><a href="module-player.html">player</a></li><li><a href="module-PythonAPI.html">PythonAPI</a></li><li><a href="module-renameController.html">renameController</a></li><li><a href="module-renderer.html">renderer</a></li><li><a href="module-ReportErrorCtrl.html">ReportErrorCtrl</a></li><li><a href="module-SaveScriptCtrl.html">SaveScriptCtrl</a></li><li><a href="module-uploader.html">uploader</a></li><li><a href="module-userConsole.html">userConsole</a></li><li><a href="module-userNotification.html">userNotification</a></li><li><a href="module-WaveforrmCache.html">WaveforrmCache</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addESTagToLog">addESTagToLog</a></li><li><a href="global.html#addESTagToNotLog">addESTagToNotLog</a></li><li><a href="global.html#addESTagToNotPrint">addESTagToNotPrint</a></li><li><a href="global.html#addESTagToPrint">addESTagToPrint</a></li><li><a href="global.html#esconsole">esconsole</a></li><li><a href="global.html#ESLog">ESLog</a></li><li><a href="global.html#formatResultForTests">formatResultForTests</a></li><li><a href="global.html#formatScriptForTests">formatScriptForTests</a></li><li><a href="global.html#getURLParameters">getURLParameters</a></li><li><a href="global.html#ServiceWrapper">ServiceWrapper</a></li><li><a href="global.html#setESConsoleTraceLevel">setESConsoleTraceLevel</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.3</a> on Thu Feb 11 2016 16:06:08 GMT-0500 (EST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
